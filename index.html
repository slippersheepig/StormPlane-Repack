<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>沙漠风暴REPACK</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
</head>
<body>
  <!-- 背景和游戏容器 -->
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div id="game-container">
    <canvas id="game-canvas"></canvas>
  </div>
  <!-- HUD：分数/生命/难度 -->
  <div id="hud" aria-hidden="true">
    <div id="score">分数：0</div>
    <div id="lives">生命：100</div>
    <div id="level">难度：普通</div>
  </div>
  <!-- 首页菜单 -->
  <div id="menu">
    <div class="panel">
      <h1>沙漠风暴 REPACK</h1>
      <div class="btns" id="diff-buttons" role="group" aria-label="选择难度">
        <button type="button" data-diff="easy">简单</button>
        <button type="button" data-diff="normal" class="active">普通</button>
        <button type="button" data-diff="hard">困难</button>
      </div>
      <button id="start-btn" class="primary">开始游戏</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
  <script>
  (async () => {
    const imgs = [
      "./img/blue_plane.png","./img/red_plane.png","./img/purple_plane.png",
      "./img/small_enemy.png","./img/big_enemy.png","./img/boss_enemy.png",
      "./img/red_bullet.png","./img/blue_bullet.png","./img/big_enemy_bullet.png",
      "./img/boom.png","./img/bullet_goods1.png","./img/plane_shield.png",
      "./img/life_goods.png","./img/missile_goods.png","./img/text.png",
      "./img/small.png","./img/big.png","./img/boosplane.png","./img/bigplane_bullet.png",
      "./img/myplaneexplosion.png","./img/bullet_goods2.png","./img/purple_bullet_goods.png",
      "./img/red_bullet_goods.png","./img/missile_goods.png","./img/bg_01.jpg","./img/bg_02.jpg"
    ];

    await Promise.all(imgs.map(p => new Promise((res) => {
      const img = new Image();
      img.onload = () => res({path: p, ok: true});
      img.onerror = () => {
        console.warn("Image failed to load:", p);
        res({path: p, ok: false});
      };
      img.src = p;
    })));

    try {
      const pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/"});

      const utilsResp = await fetch("utils.py");
      if (!utilsResp.ok) throw new Error("无法读取 utils.py: " + utilsResp.status);
      const utilsCode = await utilsResp.text();
      pyodide.FS.writeFile("/utils.py", utilsCode);
      try { pyodide.FS.mkdir("utils"); } catch(e) {}
      pyodide.FS.writeFile("utils/__init__.py", utilsCode);

      const mainResp = await fetch("main.py");
      if (!mainResp.ok) throw new Error("无法读取 main.py: " + mainResp.status);
      const mainCode = await mainResp.text();
      await pyodide.runPythonAsync(mainCode);
      console.log("Python 游戏逻辑启动完成");
    } catch (err) {
      console.error("Failed to load/run Python code:", err);
      alert("加载 Python 失败：" + err);
    }
  })();
  </script>
</body>
</html>
