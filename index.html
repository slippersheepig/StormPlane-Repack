<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>沙漠风暴REPACK</title>
  <link rel="icon" 
        href="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
          <defs>
            <linearGradient id='shipGrad' x1='0%' y1='0%' x2='100%' y2='100%'>
              <stop offset='0%' stop-color='%23a1c4fd'/>
              <stop offset='100%' stop-color='%230c3483'/>
            </linearGradient>
            <radialGradient id='flameGrad' cx='50%' cy='50%' r='50%'>
              <stop offset='0%' stop-color='%23ffff66'/>
              <stop offset='50%' stop-color='%23ff6600'/>
              <stop offset='100%' stop-color='%23cc0000'/>
            </radialGradient>
            <filter id='doubleGlow' x='-50%' y='-50%' width='200%' height='200%'>
              <feGaussianBlur in='SourceGraphic' stdDeviation='6' result='outerBlur'/>
              <feMerge>
                <feMergeNode in='outerBlur'/>
                <feGaussianBlur in='SourceGraphic' stdDeviation='2' result='innerBlur'/>
                <feMergeNode in='innerBlur'/>
                <feMergeNode in='SourceGraphic'/>
              </feMerge>
            </filter>
          </defs>
          <ellipse cx='50' cy='60' rx='25' ry='15' 
                   fill='url(%23shipGrad)' filter='url(%23doubleGlow)'/>
          <circle cx='50' cy='50' r='10' fill='%23add8e6' stroke='%23033e80' stroke-width='2'/>
          <polygon points='35,60 30,75 40,70' fill='%235577aa'/>
          <polygon points='65,60 70,75 60,70' fill='%235577aa'/>
          <ellipse cx='50' cy='78' rx='10' ry='18' fill='url(%23flameGrad)' opacity='0.8'/>
          <circle cx='20' cy='20' r='2' fill='%23ffffff'/>
          <circle cx='80' cy='30' r='1.5' fill='%23ffffff'/>
          <circle cx='70' cy='15' r='1' fill='%23ffffff'/>
          <circle cx='25' cy='40' r='1.2' fill='%23ffffff'/>
          <circle cx='85' cy='65' r='1.8' fill='%23ffffff'/>
        </svg>">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- 背景和游戏容器 -->
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div id="game-container">
    <canvas id="game-canvas" tabindex="0" aria-label="游戏画布"></canvas>
  </div>
  <!-- HUD：分数/生命/难度 -->
  <div id="hud" aria-hidden="true">
    <div id="score">分数：0</div>
    <div id="lives">生命：100</div>
    <div id="level">难度：普通</div>
  </div>
  <div id="loading" aria-hidden="false" role="status" aria-label="加载中">
    <div class="loader-circle" role="presentation">
      <svg class="progress" viewBox="0 0 36 36" aria-hidden="true">
        <path class="bg" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831a15.9155 15.9155 0 1 0 0-31.831"/>
        <path class="meter" stroke-dasharray="0,100" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831a15.9155 15.9155 0 1 0 0-31.831"/>
      </svg>
      <div class="progress-text">0%</div>
      <div class="sr-only">正在加载资源，请稍候...</div>
    </div>
  </div>
  <script>
  (function ensureLoader(){
    try {
      const ld = document.getElementById('loading');
      if(!ld) return;
      if(ld.querySelector && ld.querySelector('.spinner')) {
        ld.innerHTML = `
        <div class="loader-circle" role="presentation">
          <svg class="progress" viewBox="0 0 36 36" aria-hidden="true">
            <path class="bg" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831a15.9155 15.9155 0 1 0 0-31.831"/>
            <path class="meter" stroke-dasharray="0,100" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831a15.9155 15.9155 0 1 0 0-31.831"/>
          </svg>
          <div class="progress-text">0%</div>
          <div class="sr-only">正在加载资源，请稍候...</div>
        </div>`;
      }
      try {
        const s = document.createElement('style');
        s.textContent = "#loading .spinner{display:none !important;} #loading .loader-circle{display:flex !important;}";
        document.head.appendChild(s);
      } catch(e){}
    } catch(e){}
  })();
  </script>
  <!-- 首页菜单 -->
  <div id="menu">
    <div class="panel">
      <h1>沙漠风暴 REPACK</h1>
      <div class="btns" id="diff-buttons" role="group" aria-label="选择难度">
        <button type="button" data-diff="easy">简单</button>
        <button type="button" data-diff="normal" class="active">普通</button>
        <button type="button" data-diff="hard">困难</button>
      </div>
      <button id="start-btn" class="primary">开始游戏</button>
    </div>
  </div>
  <script>
    // 在 Pyodide/Python 就绪前，先用原生 JS 记录用户的点击
    (function () {
      const menu = document.getElementById('menu');
      const diffBtns = document.querySelectorAll('#diff-buttons button');
      let selected = 'normal';

      diffBtns.forEach(btn => {
        btn.addEventListener('click', function () {
          diffBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          selected = this.dataset.diff;
          window.__desiredDifficulty = selected;
        }, { passive: true });
      });

      document.getElementById('start-btn').addEventListener('click', function () {
        // 标记用户已经点过“开始”，等 Python 就绪后自动开局
        window.__startClicked = true;
      }, { passive: true });
    })();
  </script>
  <script src="https://o.sheepgreen.top/pyodide/v0.28.1/full/pyodide.js"></script>
  <script>
    (async () => {
      const imgs = [
        "./img/bg_01.jpg","./img/bg_02.jpg",
        "./img/blue_plane.png","./img/red_plane.png","./img/purple_plane.png",
        "./img/small_enemy.png","./img/big_enemy.png","./img/boss_enemy.png",
        "./img/red_bullet.png","./img/blue_bullet.png","./img/big_enemy_bullet.png",
        "./img/boom.png","./img/bullet_goods1.png","./img/plane_shield.png",
        "./img/life_goods.png","./img/missile_goods.png","./img/text.png",
        "./img/small.png","./img/big.png","./img/boosplane.png","./img/bigplane_bullet.png",
        "./img/myplaneexplosion.png","./img/bullet_goods2.png","./img/purple_bullet_goods.png",
        "./img/red_bullet_goods.png","./img/purple_plane.png","./img/red_plane.png"
      ];
      window.PRELOADED_IMAGES = {};
      // Progressive loader: count total assets and update UI
      const audios = ["./sound/game.mp3"];
      const totalAssets = imgs.length + audios.length;
      let loadedAssets = 0;
      function updateProgress() {
        const pct = Math.round((loadedAssets/totalAssets)*100);
        const meter = document.querySelector('#loading .meter');
        const text = document.querySelector('#loading .progress-text');
        if (meter) meter.setAttribute('stroke-dasharray', pct + ',100');
        if (text) text.textContent = pct + '%';
      }

      await Promise.all(imgs.map(p => new Promise((res) => {
        const img = new Image();
        img.onload = () => { window.PRELOADED_IMAGES[p] = img; loadedAssets++; updateProgress(); res(true); };
        img.onerror = () => { console.warn("Image failed to load:", p); window.PRELOADED_IMAGES[p] = null; loadedAssets++; updateProgress(); res(false); };
        img.src = p;
      })));

      window.PRELOADED_AUDIO = {};
      // Try to preload audio, but use a timeout fallback because some mobile browsers (iOS Safari) block audio events until user interaction.
      await Promise.all(audios.map(p => new Promise(res => {
       try {
          const a = new Audio();
          a.preload = "auto";
          a.src = p;
          let resolved = false;
          function doResolve(ok) {
            if (resolved) return;
            resolved = true;
            if (ok) window.PRELOADED_AUDIO[p] = a; else window.PRELOADED_AUDIO[p] = null;
            loadedAssets++; updateProgress();
            res(ok);
          }
          a.oncanplaythrough = () => doResolve(true);
          a.onerror = () => doResolve(false);
          // Fallback: resolve (as NOT loaded) after 1200ms so loader won't hang at ~96% on iOS.
          setTimeout(() => doResolve(false), 1200);
        } catch (e) {
          console.warn("Audio preload error:", e);
          window.PRELOADED_AUDIO[p] = null;
          loadedAssets++; updateProgress();
          res(false);
        }
      })));
  
      try {
        const pyodide = await loadPyodide();
        const utilsCode = await fetch("utils.py").then(r => r.text());
        pyodide.FS.writeFile("/utils.py", utilsCode);
        try { pyodide.FS.mkdir("utils"); } catch(e) {}
        pyodide.FS.writeFile("utils/__init__.py", utilsCode);
        const mainCode = await fetch("main.py").then(r => r.text());
        await pyodide.runPythonAsync(mainCode);
        try {
          const ld = document.getElementById('loading');
          if (ld) { ld.setAttribute('aria-hidden','true'); ld.style.display='none'; }
        } catch(e) { console.warn('hide loading failed', e); }
      } catch (err) {
        console.error("Failed to load/run Python code:", err);
        alert("加载 Python 失败：" + err);
      }
    })();
  </script>
</body>
</html>
